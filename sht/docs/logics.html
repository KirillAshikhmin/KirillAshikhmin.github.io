<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Логические сценарии в Sprut.Hub — Документация</title>
  <meta name="description" content="Что такое логические сценарии Sprut.Hub, как их создавать, подключать к устройствам и отлаживать. Примеры, триггеры и рекомендации.">

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <section class="hero-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <h1><i class="fas fa-gears"></i> Логические сценарии</h1>
          <p class="lead">Что это, как устроены, как подключать к устройствам и отлаживать</p>
          <p class="text-warning small">В описании могут быть неточности и ошибки. Пишите замечания в Telegram: <a href="https://t.me/smart_sputnik" class="custom-link-blue">Умный Спутник</a>.</p>
          <p>
            Источники:
            <a href="https://github.com/KirillAshikhmin/Sprut.Hub_Tools/tree/main/ScenarioTemplate" class="custom-link-white">ScenarioTemplate (основной)</a>,
            <a href="https://wiki.spruthub.ru/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8_%D0%B2_Sprut.hub_-_%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5_%D1%8D%D0%BB%D0%B5%D0%BC%D0%B5%D0%BD%D1%82%D1%8B_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F" class="custom-link-white">Элементы управления сценариями</a>,
            <a href="https://wiki.spruthub.ru/%D0%9B%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5_%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8" class="custom-link-white">Логические сценарии</a>
          </p>
        </div>
        <div class="col-lg-4 text-center">
          <i class="fas fa-diagram-project hero-cogs"></i>
        </div>
      </div>
    </div>
  </section>

  <main class="container">
    <div class="mb-4">
      <a href="https://github.com/KirillAshikhmin/Sprut.Hub_Tools/tree/main/ScenarioTemplate" class="category-btn control"><i class="fas fa-code"></i> Шаблон логического сценария</a>
    </div>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-brain"></i> Введение простыми словами</h2>
      <div class="card scenario-card"><div class="card-body">
        <p>
          Логические сценарии — это скрипты на JavaScript (движок Nashorn) и поддерживает только стандарт ES6 (ECMAScript 6), которые добавляют настраиваемую «логику» для выбранных типов устройств. Вы подключаете сценарий к устройству, выбираете триггер (событие), а код сценария реагирует и выполняет действия.
        </p>
        <ul>
          <li>Сценарий появляется у подходящих устройств после сохранения и проверки его корректности.</li>
          <li>Название пользовательского сценария должно отличаться от встроенных/существующих.</li>
          <li>Срабатывает только от указанного триггера и только для поддерживаемых типов устройств.</li>
          <li>Кнопка теста редактора не запускает логический сценарий (он зависит от события).</li>
        </ul>
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-road"></i> Быстрый старт</h2>
      <div class="card scenario-card"><div class="card-body">
        <ol>
          <li>Откройте примерную структуру в <a href="https://github.com/KirillAshikhmin/Sprut.Hub_Tools/tree/main/ScenarioTemplate">ScenarioTemplate</a>.</li>
          <li>Создайте новый сценарий на его основе: задайте уникальное имя и целевые типы устройств/сервисов.</li>
          <li>Определите триггер(ы) сценария (например, изменение характеристики сервиса).</li>
          <li>Напишите логику на JavaScript: чтение/запись характеристик, условия, задержки и т.д.</li>
          <li>Сохраните. Сценарий автоматически станет доступен в разделе «Логика» подходящих устройств, если корректен.</li>
          <li>Подключите сценарий к нужному устройству: Настройки устройства → Логика → выбрать сервис → добавить логику.</li>
        </ol>
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-sitemap"></i> Структура логического сценария</h2>
      <div class="card scenario-card"><div class="card-body">
        <p>
          Структура приведена строго по README (раздел «Написание сценариев → Логические → Структура сценария») и примеру <a href="https://github.com/KirillAshikhmin/Sprut.Hub_Tools/blob/main/ScenarioTemplate/LogicScenarioTemplate.js">LogicScenarioTemplate.js</a>.
        </p>
        <pre><code>info = {
  name: "Название сценария",
  description: "Описание сценария",
  version: "1.0",
  author: "@Author",
  onStart: true,
  sourceServices: [HS.Switch],
  sourceCharacteristics: [HC.On],
  options: {},
  variables: {}
}

function trigger(source, value, variables, options, context) {
}

function compute(source, value, variables, options, context) {
}</code></pre>
        <h5 class="mt-3">Объект info</h5>
        <ul>
          <li><b>name</b>: название сценария.</li>
          <li><b>description</b>: описание сценария.</li>
          <li><b>version</b>: версия (строка).</li>
          <li><b>author</b>: автор сценария.</li>
          <li><b>onStart</b>: выполнять при старте (<code>true/false</code>).</li>
          <li><b>sourceServices</b>: массив типов сервисов (<code>HS.*</code>). Смотрите «Типы сервисов» в хабе/редакторе.</li>
          <li><b>sourceCharacteristics</b>: массив характеристик (<code>HC.*</code>).</li>
          <li><b>options</b>: объект опций сценария, доступных в коде.</li>
          <li><b>variables</b>: объект переменных сценария, доступных в коде.</li>
        </ul>
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-bolt"></i> Функция trigger(source, value, variables, options, context)</h2>
      <div class="card scenario-card"><div class="card-body">
        <p><b>Назначение:</b> Основная функция сценария. </p>
        <p>Является главной функцией и точкой входа в сценарии. Вызывается системой после выполнения compute и фактической установки значения.<br/>При включённом onStart в блоке info вызывается при запуске хаба и при сохранении сценария с текущим значением характеристики. Работает ассинхронно.</p>
        <pre><code>function trigger(source, value, variables, options, context) {
          // Код сценария
}</code></pre>
        <ul>
          <li>Вызывается после <code>compute(source, value, variables, options, context)</code>.</li>
          <li>Используется для выполнения основной логики (управление устройствами, записи характеристик и т.п.).</li>
          <li>Используйте методы API хаба из раздела «Список доступных методов в коде» на вики.</li>
        </ul>
        <h6 class="mt-3">Параметры</h6>
        <ul>
          <li><b>source</b>: источник события — объект характеристики устройства, изменение которой привело к срабатыванию сценария.</li>
          <li><b>value</b>: новое значение характеристики (после применения <code>compute</code>, если оно меняло значение).</li>
          <li><b>variables</b>: объект переменных сценария (сохраняется между вызовами; можно читать и изменять).</li>
          <li><b>options</b>: объект опций сценария, заданных в <code>info.options</code> и настраиваемых в интерфейсе. Только для чтения.</li>
          <li><b>context</b>: контекст вызова события - откуда пришло событие и какой путь привёл к его вызову до сценария.</li>
        </ul>
      
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-play"></i> Функция compute(source, value, variables, options, context)</h2>
      <div class="card scenario-card"><div class="card-body">
        <p><b>Назначение:</b> Изменить устанавливаемое значение характеристики.</p>
          <p>Вызывается при изменении характеристики. Результат устанавливается в характеристику. </p>
        <pre><code>function compute(source, value, variables, options, context) {
          return value;
}</code></pre>
        <ul>
          <li>Параметры соответствуют параметрам <code>trigger</code>: <code>source</code>, <code>value</code>, <code>variables</code>, <code>options</code>, <code>context</code>.</li>
          <li>Вызывается первой для каждого события.</li>
          <li>ВНИМАНИЕ! Функция выполняется синхронно и может замедлять работу хаба или приводить к неожиданному поведению. Применять только при острой необходимости и с особой осторожностью. Не выполнять в ней сложных вычислений или долгих операций.</li>
        </ul>
     
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-code"></i> Доступные методы в коде</h2>
      <div class="card scenario-card"><div class="card-body">
        <p>
          Полный список методов и возможностей API логических сценариев смотрите в разделе «Список доступных методов в коде» на вики.
          Ориентируйтесь на статьи:
          <a href="https://wiki.spruthub.ru/%D0%9B%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5_%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8">Логические сценарии</a>
          и
          <a href="https://wiki.spruthub.ru/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8_%D0%B2_Sprut.hub_-_%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5_%D1%8D%D0%BB%D0%B5%D0%BC%D0%B5%D0%BD%D1%82%D1%8B_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F">Элементы управления сценарием</a>.
        </p>
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-bug"></i> Проверка и отладка</h2>
      <div class="card scenario-card"><div class="card-body">
        <ul>
          <li>Ошибки кода подсвечиваются в редакторе. Некорректный сценарий не появится в списке доступных логик у устройств.</li>
          <li>При необходимости временно отключайте логику в настройках устройства для проверки различных сценариев поведения.</li>
          <li>Последовательное выполнение действий в сценарии (если задействовано) может ждать завершения записи значения перед чтением — учитывайте это при проектировании.</li>
        </ul>
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-lightbulb"></i> Рекомендации</h2>
      <div class="card scenario-card"><div class="card-body">
        <ul>
          <li>Начинайте с простого сценария и одного триггера. Расширяйте постепенно.</li>
          <li>Всегда проверяйте, не дублирует ли ваш сценарий штатную логику реального устройства.</li>
          <li>Используйте «Типы сервисов» в хабе/редакторе, чтобы выбрать корректные характеристики и их значения.</li>
        </ul>
      </div></div>
    </section>

    <section class="mb-5">
      <h2 class="mb-3"><i class="fas fa-link"></i> Ссылки</h2>
      <ul>
        <li><a href="https://github.com/KirillAshikhmin/Sprut.Hub_Tools/tree/main/ScenarioTemplate">ScenarioTemplate — основной источник</a></li>
        <li><a href="https://wiki.spruthub.ru/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8_%D0%B2_Sprut.hub_-_%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5_%D1%8D%D0%BB%D0%B5%D0%BC%D0%B5%D0%BD%D1%82%D1%8B_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F">Сценарии в Sprut.hub — основные элементы управления</a></li>
        <li><a href="https://wiki.spruthub.ru/%D0%9B%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5_%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8">Логические сценарии</a></li>
      </ul>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-6"><h5>Следить за обновлениями</h5><p>Telegram: <a href="https://t.me/smart_sputnik" class="custom-link-blue">Умный Спутник</a></p></div>
        <div class="col-md-6 text-md-end"><h5>Поддержать автора</h5><p><a href="https://boosty.to/smart_kirill" class="custom-link-blue">Boosty</a></p></div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


